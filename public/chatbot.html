<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Teja GPT</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .sidebar { background-color: #2d2d2d; }
        .chat-area { background-color: #1e1e1e; }
        .input-area { background-color: #252525; }
        .btn-primary { background-color: #4a4a4a; }
        .btn-primary:hover { background-color: #5a5a5a; }
        .btn-danger { background-color: #991b1b; }
        .btn-danger:hover { background-color: #b91c1c; }
        .form-input { background-color: #3c3c3c; border-color: #555; }
        .message { background-color: #333333; }
        .message.own { background-color: #004d40; }
        .chat-item.active { background-color: #4a4a4a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d2d2d; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            align-items: center; justify-content: center; z-index: 50;
        }
        .modal-content {
            background-color: #2d2d2d; padding: 2rem; border-radius: 0.5rem;
            max-width: 400px; width: 90%; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        #auth-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; display: block;
        }
        .auth-form-container {
            position: relative; z-index: 1;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #5a5a5a;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Mobile specific styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100%;
                z-index: 40;
                transition: left 0.3s ease-in-out;
                width: 288px; /* w-72 */
            }
            .sidebar.open {
                left: 0;
            }
            #content-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 39;
                display: none;
            }
            #content-overlay.active {
                display: block;
            }
            #menu-btn {
                display: block;
            }
        }
        @media (min-width: 769px) {
            #menu-btn {
                display: none;
            }
        }
    </style>
</head>
<body class="overflow-hidden">
    <!-- Mobile Hamburger Menu Button -->
    <button id="menu-btn" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-gray-800 text-white hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    <div id="content-overlay"></div>

    <div id="app-container" class="flex h-screen">

        <!-- Auth Section -->
        <div id="auth-section" class="w-full h-full flex items-center justify-center p-4 relative">
            <canvas id="auth-canvas"></canvas>
            <div class="w-full max-w-md space-y-8 auth-form-container">
                <div>
                    <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-white">
                        Sign in to your account
                    </h2>
                </div>
                <form id="auth-form" class="mt-8 space-y-6" action="#" method="POST">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div><input id="email" name="email" type="email" autocomplete="email" required class="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 text-white rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address"></div>
                        <div><input id="password" name="password" type="password" autocomplete="current-password" required class="form-input appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 text-white rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password"></div>
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-75">
                            <span class="btn-text">Sign In</span>
                            <div class="loader hidden"></div>
                        </button>
                    </div>
                </form>
                <p class="text-center text-sm"><a href="#" id="toggle-auth-mode" class="font-medium text-indigo-400 hover:text-indigo-300">Don't have an account? Sign Up</a></p>
            </div>
        </div>

        <!-- Main App (Hidden by default) -->
        <div id="main-app" class="hidden w-full h-full flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-72 flex-shrink-0 flex flex-col p-4 border-r border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold">History</h1>
                    <button id="new-chat-btn" class="p-2 rounded-md hover:bg-gray-600" title="New Chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div id="chat-list" class="flex-1 space-y-2 overflow-y-auto">
                    <!-- Chat list will be populated here -->
                </div>
                <div class="mt-auto">
                    <div id="user-profile-display" class="flex items-center mb-4 cursor-pointer p-2 rounded-md hover:bg-gray-600" title="Edit Profile">
                        <img id="sidebar-avatar" src="https://placehold.co/40x40/2d2d2d/e0e0e0?text=U" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <p id="sidebar-username" class="font-semibold">Loading...</p>
                            <p id="sidebar-email" class="text-xs text-gray-400"></p>
                        </div>
                    </div>
                    <button id="logout-btn" class="w-full btn-primary text-white py-2 px-4 rounded-md">Logout</button>
                </div>
            </aside>

            <!-- Content Area -->
            <main class="flex-1 flex flex-col">
                <div id="chat-section" class="flex-1 flex flex-col">
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <h2 id="chat-title" class="text-xl font-bold">Select a chat to start</h2>
                        <button id="clear-chat-btn" class="btn-danger text-white py-2 px-3 rounded-md flex items-center text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>Clear Chat</button>
                    </div>
                    <div id="chat-messages" class="flex-1 p-6 overflow-y-auto"></div>
                    <div class="input-area p-4 border-t border-gray-700">
                        <form id="message-form" class="flex items-center">
                            <input id="message-input" type="text" placeholder="Type your message..." class="form-input flex-1 bg-transparent text-white placeholder-gray-400 focus:outline-none px-4 py-2 rounded-lg" disabled>
                            <button type="submit" class="ml-4 btn-primary text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50" disabled>Send</button>
                        </form>
                    </div>
                </div>
                <div id="profile-section" class="hidden p-6 overflow-y-auto">
                    <div class="flex items-center mb-6">
                         <button id="back-to-chat-btn" class="p-2 rounded-full hover:bg-gray-600 mr-4"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                         <h2 class="text-2xl font-bold">Edit Profile</h2>
                    </div>
                    <form id="profile-form" class="space-y-4 max-w-lg">
                        <div><label for="username" class="block text-sm font-medium">Username</label><input type="text" id="username" class="form-input mt-1 block w-full rounded-md" required></div>
                        <div><label for="website" class="block text-sm font-medium">Website</label><input type="url" id="website" class="form-input mt-1 block w-full rounded-md"></div>
                        <div><label for="avatar_url" class="block text-sm font-medium">Avatar URL</label><input type="url" id="avatar_url" class="form-input mt-1 block w-full rounded-md"></div>
                        <div><button type="submit" class="btn-primary text-white py-2 px-4 rounded-md">Update Profile</button></div>
                    </form>
                </div>
                 <!-- Footer -->
                <footer class="p-4 text-center text-xs text-gray-500">
                    © 2025 Teja GPT. All rights reserved.
                </footer>
            </main>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="confirm-title" class="text-xl font-bold mb-4">Are you sure?</h3>
            <p id="confirm-text" class="text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="btn-primary text-white py-2 px-4 rounded-md">Cancel</button>
                <button id="confirm-ok-btn" class="btn-danger text-white py-2 px-4 rounded-md">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // === SUPABASE & OPENROUTER SETUP ===
        const SUPABASE_URL = 'https://bugyqxwahckhaocwqpgo.supabase.co'; // <-- IMPORTANT: Replace
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1Z3lxeHdhaGNraGFvY3dxcGdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDQ2MDMsImV4cCI6MjA3MDk4MDYwM30.tidAr93dNAkvSyCXLi6DMImbecVteO_rCfKNj9rFiqw'; // <-- IMPORTANT: Replace
        const OPENROUTER_API_KEY = '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'; // <-- IMPORTANT: Replace
        const OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions";
     
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // === DOM ELEMENTS ===
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
        const logoutBtn = document.getElementById('logout-btn');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const chatSection = document.getElementById('chat-section');
        const profileSection = document.getElementById('profile-section');
        const profileForm = document.getElementById('profile-form');
        const sidebar = document.getElementById('sidebar');
        const sidebarAvatar = document.getElementById('sidebar-avatar');
        const sidebarUsername = document.getElementById('sidebar-username');
        const sidebarEmail = document.getElementById('sidebar-email');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatList = document.getElementById('chat-list');
        const chatTitle = document.getElementById('chat-title');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const userProfileDisplay = document.getElementById('user-profile-display');
        const backToChatBtn = document.getElementById('back-to-chat-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const menuBtn = document.getElementById('menu-btn');
        const contentOverlay = document.getElementById('content-overlay');

        // === STATE MANAGEMENT ===
        let isSignUp = false;
        let currentUser = null;
        let activeChatId = null;
        let chats = [];
        let confirmCallback = null;
        let animationFrameId;

        // === 3D ANIMATION LOGIC ===
        let scene, camera, renderer, sphere;
        const authCanvas = document.getElementById('auth-canvas');

        function init3DAnimation() {
            authCanvas.style.display = 'block';
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: authCanvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            const geometry = new THREE.IcosahedronGeometry(2, 1);
            const material = new THREE.MeshBasicMaterial({ color: 0x5a5a5a, wireframe: true });
            sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
            camera.position.z = 5;
            animate();
        }

        function animate() {
            animationFrameId = requestAnimationFrame(animate);
            sphere.rotation.x += 0.001;
            sphere.rotation.y += 0.001;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            if (renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // === AUTHENTICATION LOGIC ===
        const toggleAuthMode = () => {
            isSignUp = !isSignUp;
            const btnText = authForm.querySelector('.btn-text');
            authTitle.textContent = isSignUp ? 'Create a new account' : 'Sign in to your account';
            btnText.textContent = isSignUp ? 'Sign Up' : 'Sign In';
            toggleAuthModeLink.textContent = isSignUp ? 'Already have an account? Sign In' : "Don't have an account? Sign Up";
        };
        toggleAuthModeLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthMode(); });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            try {
                const { error } = isSignUp ? await _supabase.auth.signUp({ email, password }) : await _supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        });

        logoutBtn.addEventListener('click', () => _supabase.auth.signOut());

        // === UI MANAGEMENT ===
        const showMainApp = () => {
            authSection.classList.add('hidden');
            mainApp.classList.remove('hidden');
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        };
        const showAuth = () => {
            mainApp.classList.add('hidden');
            authSection.classList.remove('hidden');
            if (!animationFrameId) {
                init3DAnimation();
            }
        };
        
        const navigateTo = (section) => {
            [chatSection, profileSection].forEach(s => s.classList.add('hidden'));
            if (section === 'chat') chatSection.classList.remove('hidden');
            else if (section === 'profile') profileSection.classList.remove('hidden');
            closeSidebar();
        };
        userProfileDisplay.addEventListener('click', (e) => { e.preventDefault(); navigateTo('profile'); });
        backToChatBtn.addEventListener('click', (e) => { e.preventDefault(); navigateTo('chat'); });
        
        const showConfirmModal = (title, text, callback) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-text').textContent = text;
            confirmCallback = callback;
            confirmModal.classList.remove('hidden');
        };
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => confirmModal.classList.add('hidden'));
        document.getElementById('confirm-ok-btn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
        });

        // Mobile Sidebar Logic
        const openSidebar = () => {
            sidebar.classList.add('open');
            contentOverlay.classList.add('active');
        };
        const closeSidebar = () => {
            sidebar.classList.remove('open');
            contentOverlay.classList.remove('active');
        };
        menuBtn.addEventListener('click', openSidebar);
        contentOverlay.addEventListener('click', closeSidebar);

        // === PROFILE MANAGEMENT ===
        const fetchUserProfile = async (user) => {
            if (!user) return null;
            const { data, error } = await _supabase.from('profiles').select(`username, website, avatar_url`).eq('id', user.id).single();
            if (error && error.code !== 'PGRST116') console.error('Error fetching profile:', error);
            return data;
        };
        
        const ensureUserProfile = async (user) => {
            let profile = await fetchUserProfile(user);
            if (!profile) {
                let username = user.email.split('@')[0];
                const { error } = await _supabase.from('profiles').insert({ id: user.id, username, updated_at: new Date() });
                if (error && error.code === '23505') {
                    const newUsername = `${username}${Math.floor(Math.random() * 1000)}`;
                    const { error: newError } = await _supabase.from('profiles').insert({ id: user.id, username: newUsername, updated_at: new Date() });
                    if (newError) console.error("Error creating profile with random suffix:", newError);
                } else if (error) console.error("Error creating profile:", error);
                profile = await fetchUserProfile(user);
            }
            return profile;
        };

        const updateUserProfileUI = (profile, user) => {
            sidebarUsername.textContent = profile?.username || 'New User';
            sidebarEmail.textContent = user.email;
            sidebarAvatar.src = profile?.avatar_url || `https://placehold.co/40x40/2d2d2d/e0e0e0?text=${(profile?.username || user.email)[0].toUpperCase()}`;
            document.getElementById('username').value = profile?.username || '';
            document.getElementById('website').value = profile?.website || '';
            document.getElementById('avatar_url').value = profile?.avatar_url || '';
        };
        
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const updates = { id: currentUser.id, username: e.target.username.value, website: e.target.website.value, avatar_url: e.target.avatar_url.value, updated_at: new Date() };
            const { error } = await _supabase.from('profiles').upsert(updates);
            if (error) alert(`Error: ${error.message}`);
            else { alert('Profile updated successfully!'); updateUserProfileUI(updates, currentUser); }
        });

        // === CHAT LOGIC ===
        const renderChatList = () => {
            chatList.innerHTML = '';
            if (chats.length === 0) {
                chatList.innerHTML = `<p class="text-center text-gray-400 text-sm">No chats yet.</p>`;
                return;
            }
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item p-3 rounded-md cursor-pointer hover:bg-gray-600 truncate ${chat.id === activeChatId ? 'active' : ''}`;
                chatItem.textContent = chat.title;
                chatItem.dataset.chatId = chat.id;
                chatItem.addEventListener('click', () => setActiveChat(chat.id));
                chatList.appendChild(chatItem);
            });
        };

        const fetchChats = async () => {
            if (!currentUser) return;
            const { data, error } = await _supabase.from('chats').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            if (error) console.error("Error fetching chats:", error);
            else {
                chats = data;
                renderChatList();
                if (!activeChatId && chats.length > 0) {
                    setActiveChat(chats[0].id);
                } else if (activeChatId && !chats.some(c => c.id === activeChatId)) {
                     setActiveChat(chats.length > 0 ? chats[0].id : null);
                } else if (chats.length === 0) {
                    setActiveChat(null);
                }
            }
        };

        const setActiveChat = async (chatId) => {
            activeChatId = chatId;
            if (chatId) {
                const currentChat = chats.find(c => c.id === chatId);
                chatTitle.textContent = currentChat?.title || 'Chat';
                messageInput.disabled = false;
                messageForm.querySelector('button').disabled = false;
                clearChatBtn.disabled = false;
                await fetchMessages();
            } else {
                chatTitle.textContent = 'Select or create a chat';
                chatMessages.innerHTML = '';
                messageInput.disabled = true;
                messageForm.querySelector('button').disabled = true;
                clearChatBtn.disabled = true;
            }
            renderChatList();
            closeSidebar();
        };

        newChatBtn.addEventListener('click', async () => {
            const { data, error } = await _supabase.from('chats').insert({ user_id: currentUser.id }).select().single();
            if (error) console.error("Error creating new chat:", error);
            else {
                chats.unshift(data);
                setActiveChat(data.id);
            }
        });
        
        clearChatBtn.addEventListener('click', () => {
            if (!activeChatId) return;
            showConfirmModal('Clear Chat History', 'Are you sure you want to delete all messages in this chat?', async () => {
                const { error } = await _supabase.from('messages').delete().eq('chat_id', activeChatId);
                if (error) {
                    console.error("Error clearing chat:", error);
                } else {
                    chatMessages.innerHTML = '';
                    const { error: deleteChatError } = await _supabase.from('chats').delete().eq('id', activeChatId);
                    if (deleteChatError) console.error("Error deleting chat:", deleteChatError);
                    else await fetchChats();
                }
            });
        });

        const addMessageToUI = (message) => {
            const messageDiv = document.createElement('div');
            const isUserMessage = message.role === 'user';
            messageDiv.classList.add('message', 'p-3', 'rounded-lg', 'mb-4', 'max-w-xl');
            if (isUserMessage) {
                messageDiv.classList.add('own', 'ml-auto');
                messageDiv.innerHTML = `<p class="text-sm">${message.content}</p>`;
            } else {
                messageDiv.innerHTML = `<div class="flex items-start gap-3"><img src="https://placehold.co/40x40/4a4a4a/e0e0e0?text=AI" class="w-8 h-8 rounded-full"><div><p class="font-semibold text-sm">AI Assistant</p><p class="text-sm mt-1">${message.content}</p></div></div>`;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
        
        const showTypingIndicator = () => { /* Unchanged */ };
        const removeTypingIndicator = () => { /* Unchanged */ };

        const fetchMessages = async () => {
            if (!activeChatId) return;
            const { data, error } = await _supabase.from('messages').select(`id, content, role`).eq('chat_id', activeChatId).order('created_at', { ascending: true });
            if (error) console.error('Error fetching messages:', error);
            else { chatMessages.innerHTML = ''; data.forEach(addMessageToUI); }
        };

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = messageInput.value.trim();
            if (!content || !currentUser || !activeChatId) return;
            const userMessageContent = content;
            messageInput.value = '';

            addMessageToUI({ content: userMessageContent, role: 'user' });
            
            _supabase.from('messages').insert({ content: userMessageContent, user_id: currentUser.id, role: 'user', chat_id: activeChatId }).then(({error}) => {
                if (error) console.error("Error saving user message:", error);
            });
            
            const currentChat = chats.find(c => c.id === activeChatId);
            if (currentChat && currentChat.title === 'New Chat') {
                const title = userMessageContent.substring(0, 30) + (userMessageContent.length > 30 ? '...' : '');
                _supabase.from('chats').update({ title }).eq('id', activeChatId).then(({error}) => {
                    if (!error) {
                        currentChat.title = title;
                        renderChatList();
                        chatTitle.textContent = title;
                    }
                });
            }

            showTypingIndicator();

            const { data: history } = await _supabase.from('messages').select('role, content').eq('chat_id', activeChatId).order('created_at', { ascending: false }).limit(10);
            const apiMessages = (history || []).reverse().map(msg => ({ role: msg.role, content: msg.content }));

            try {
                const response = await fetch(OPENROUTER_API_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${OPENROUTER_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "openai/gpt-oss-20b", messages: apiMessages })
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                const aiContent = data.choices[0].message.content;

                removeTypingIndicator();
                addMessageToUI({ content: aiContent, role: 'assistant' });
                
                _supabase.from('messages').insert({ content: aiContent, user_id: currentUser.id, role: 'assistant', chat_id: activeChatId });
            } catch (err) {
                console.error("OpenRouter API Error:", err);
                removeTypingIndicator();
                const errorMessage = "Sorry, I couldn't connect to the AI. Please check your API key.";
                addMessageToUI({ content: errorMessage, role: 'assistant' });
                _supabase.from('messages').insert({ content: errorMessage, user_id: currentUser.id, role: 'assistant', chat_id: activeChatId });
            }
        });

        // === INITIALIZATION & AUTH STATE CHANGES ===
        _supabase.auth.onAuthStateChange(async (event, session) => {
            if (session && session.user) {
                currentUser = session.user;
                showMainApp();
                navigateTo('chat');
                
                const profile = await ensureUserProfile(currentUser);
                updateUserProfileUI(profile, currentUser);
                await fetchChats();
            } else {
                currentUser = null;
                activeChatId = null;
                chats = [];
                showAuth();
            }
        });
    </script>
</body>
</html>
