<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TejaGPT ‚Äî AI Chat</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Three.js (3D login background) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Markdown + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

  <style>
    html, body { height: 100%; overflow: hidden; background: #0b1220; color: #e5e7eb; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }
    #chat-messages::-webkit-scrollbar { width: 10px; }
    #chat-messages::-webkit-scrollbar-thumb { background: #3f4657; border-radius: 10px; }
    .glass { background: rgba(17,24,39,.7); backdrop-filter: blur(18px); border: 1px solid rgba(255,255,255,.08); }
    .tilt { transform-style: preserve-3d; transition: transform .18s ease-out, box-shadow .25s ease; }
    .tilt:hover { box-shadow: 0 20px 60px rgba(0,0,0,.45); }
    .bubble { max-width: 72ch; border-radius: 18px; padding: .75rem 1rem; word-wrap: break-word; }
    .bubble code { background:#111827; padding:.1rem .35rem; border-radius:.35rem; }
    .bubble pre { background:#111827; padding:1rem; border-radius:.5rem; overflow:auto; }
    .typing-dot { width: 8px; height: 8px; border-radius: 9999px; background:#9aa0ae; display:inline-block; animation: blink 1.2s infinite; }
    .typing-dot:nth-child(2){ animation-delay:.2s } .typing-dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink { 0%, 80%, 100% { opacity:.2 } 40% { opacity:1 } }
    canvas#auth3d { position: fixed; inset: 0; z-index: 0; }
    #auth-card { position: relative; z-index: 1; }
  </style>
</head>
<body>

  <!-- ========= AUTH (3D) ========= -->
  <section id="auth-screen" class="w-full h-full flex items-center justify-center p-4">
    <canvas id="auth3d"></canvas>

    <div id="auth-card" class="tilt glass w-full max-w-md rounded-2xl p-8">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-extrabold tracking-tight">Welcome to <span class="text-indigo-400">TejaGPT</span></h1>
        <p class="text-sm text-gray-400 mt-2">Sign in or create an account to continue</p>
      </div>

      <div class="space-y-4">
        <input id="email" type="email" placeholder="Email"
               class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
        <input id="password" type="password" placeholder="Password"
               class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
        <div class="flex gap-3">
          <button id="login-btn"  class="flex-1 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition font-semibold">Sign in</button>
          <button id="signup-btn" class="flex-1 py-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 transition font-semibold">Sign up</button>
        </div>
        <p id="auth-error" class="text-rose-400 text-sm text-center min-h-[1.25rem]"></p>
      </div>
    </div>
  </section>

  <!-- ========= APP ========= -->
  <section id="app-screen" class="hidden w-full h-full flex items-center justify-center p-4">
    <div class="glass w-full max-w-5xl h-[86vh] rounded-2xl grid grid-rows-[auto_1fr_auto] overflow-hidden">
      <!-- Header -->
      <header class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-indigo-500/20 grid place-items-center">ü§ñ</div>
          <h2 class="font-semibold">TejaGPT Assistant</h2>
        </div>
        <div class="flex items-center gap-2">
          <button id="new-chat" class="px-3 py-2 text-sm rounded-lg bg-gray-700 hover:bg-gray-600">New chat</button>
          <button id="logout-btn" class="px-3 py-2 text-sm rounded-lg bg-rose-600 hover:bg-rose-700">Logout</button>
        </div>
      </header>

      <!-- Messages -->
      <main id="chat-messages" class="overflow-y-auto p-5 space-y-4 bg-[#0b1220]"></main>

      <!-- Composer -->
      <form id="message-form" class="border-t border-white/10 p-3 flex gap-3 bg-[#0b1220]">
        <input id="user-input" type="text" placeholder="Type your message‚Ä¶"
               class="flex-1 px-4 py-3 rounded-xl bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
        <button class="px-5 rounded-xl bg-indigo-600 hover:bg-indigo-700 font-semibold">Send</button>
      </form>
    </div>
  </section>

  <script>
    /* ===============================
       CONFIG: ADD YOUR REAL KEYS HERE
       =============================== */
    const SUPABASE_URL       = "https://bugyqxwahckhaocwqpgo.supabase.co";        // e.g. https://xxxx.supabase.co
    const SUPABASE_ANON_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1Z3lxeHdhaGNraGFvY3dxcGdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MDQ2MDMsImV4cCI6MjA3MDk4MDYwM30.tidAr93dNAkvSyCXLi6DMImbecVteO_rCfKNj9rFiqw";   // anon public key
    const OPENROUTER_API_KEY = "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";  // from https://openrouter.ai/keys
    const OPENROUTER_MODEL   = "openai/gpt-oss-20b:free";       // pick any OpenRouter model you have access to

    // Safety: warn if placeholders are not replaced
    for (const [k,v] of Object.entries({SUPABASE_URL, SUPABASE_ANON_KEY, OPENROUTER_API_KEY})) {
      if ((v||"").includes("YOUR_")) console.warn(`[config] Replace ${k} with your real value.`);
    }

    /* ===============================
       SUPABASE INIT + AUTH FLOWS
       =============================== */
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authScreen = document.getElementById("auth-screen");
    const appScreen  = document.getElementById("app-screen");
    const errorEl    = document.getElementById("auth-error");

    const emailEl    = document.getElementById("email");
    const passEl     = document.getElementById("password");

    document.getElementById("login-btn").addEventListener("click", async () => {
      errorEl.textContent = "";
      const { data, error } = await sb.auth.signInWithPassword({
        email: emailEl.value.trim(),
        password: passEl.value
      });
      if (error) { errorEl.textContent = error.message; return; }
      showApp();
    });

    document.getElementById("signup-btn").addEventListener("click", async () => {
      errorEl.textContent = "";
      const { data, error } = await sb.auth.signUp({
        email: emailEl.value.trim(),
        password: passEl.value
      });
      if (error) { errorEl.textContent = error.message; return; }
      errorEl.textContent = "‚úÖ Check your email to confirm. Then sign in.";
    });

    document.getElementById("logout-btn").addEventListener("click", async () => {
      await sb.auth.signOut();
      showAuth();
    });

    // Persist session
    sb.auth.onAuthStateChange((_event, session) => {
      if (session?.user) showApp(); else showAuth();
    });

    function showAuth() {
      appScreen.classList.add("hidden");
      authScreen.classList.remove("hidden");
    }
    function showApp() {
      authScreen.classList.add("hidden");
      appScreen.classList.remove("hidden");
      // optional: load history from your DB table if you create one later
    }

    /* ===============================
       CHAT UI + OPENROUTER
       =============================== */
    const chatEl    = document.getElementById("chat-messages");
    const formEl    = document.getElementById("message-form");
    const inputEl   = document.getElementById("user-input");
    const newChatEl = document.getElementById("new-chat");

    let conversation = [
      { role: "system", content: "You are a concise, helpful assistant. Format with Markdown when appropriate." }
    ];

    function renderMessage(role, raw) {
      const wrapper = document.createElement("div");
      wrapper.className = role === "user" ? "flex justify-end" : "flex justify-start";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (role === "user"
        ? "bg-indigo-600 text-white"
        : "bg-gray-800 text-gray-100 border border-gray-700");

      // Markdown -> safe HTML
      const html = DOMPurify.sanitize(marked.parse(String(raw ?? "")));
      bubble.innerHTML = html;

      wrapper.appendChild(bubble);
      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function showTyping() {
      const row = document.createElement("div");
      row.id = "typing";
      row.className = "flex justify-start";
      const pill = document.createElement("div");
      pill.className = "bubble bg-gray-800 border border-gray-700 text-gray-300";
      pill.innerHTML = `<span class="typing-dot"></span> <span class="typing-dot"></span> <span class="typing-dot"></span>`;
      row.appendChild(pill);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function hideTyping() { document.getElementById("typing")?.remove(); }

    newChatEl.addEventListener("click", () => {
      conversation = [conversation[0]];
      chatEl.innerHTML = "";
    });

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;

      const userMsg = { role: "user", content: text };
      conversation.push(userMsg);
      renderMessage("user", text);
      inputEl.value = "";

      showTyping();
      try {
        const assistantMsg = await callOpenRouter(conversation);
        hideTyping();
        conversation.push(assistantMsg);
        renderMessage("assistant", assistantMsg.content);
      } catch (err) {
        hideTyping();
        renderMessage("assistant", "‚ö†Ô∏è Error contacting AI: " + (err?.message || err));
      }
    });

    async function callOpenRouter(messages) {
      const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
          "Content-Type": "application/json",
          // optional routing headers:
          "HTTP-Referer": location.origin,
          "X-Title": "TejaGPT"
        },
        body: JSON.stringify({
          model: OPENROUTER_MODEL,
          messages
        })
      });
      if (!res.ok) throw new Error(`OpenRouter ${res.status} ${res.statusText}`);
      const data = await res.json();
      const content = data?.choices?.[0]?.message?.content ?? "No response.";
      return { role: "assistant", content };
    }

    /* ===============================
       3D AUTH BACKGROUND (Three.js)
       =============================== */
    const authCanvas = document.getElementById("auth3d");
    const aScene = new THREE.Scene();
    const aCam   = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
    const aRend  = new THREE.WebGLRenderer({ canvas: authCanvas, alpha: true, antialias: true });
    aRend.setSize(innerWidth, innerHeight);
    aRend.setPixelRatio(Math.min(devicePixelRatio, 2));

    const group = new THREE.Group();
    aScene.add(group);

    // Wireframe icosahedron + floating particles
    const ico = new THREE.Mesh(
      new THREE.IcosahedronGeometry(2.2, 1),
      new THREE.MeshBasicMaterial({ color: 0x6366f1, wireframe: true })
    );
    group.add(ico);

    const partGeo = new THREE.BufferGeometry();
    const count = 400;
    const positions = new Float32Array(count * 3);
    for (let i = 0; i < count * 3; i++) positions[i] = (Math.random() - .5) * 16;
    partGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    const particles = new THREE.Points(partGeo, new THREE.PointsMaterial({ size: .035, color: 0x8b95ff }));
    group.add(particles);

    aCam.position.z = 7;

    function authAnimate() {
      requestAnimationFrame(authAnimate);
      group.rotation.x += 0.0015;
      group.rotation.y += 0.002;
      aRend.render(aScene, aCam);
    }
    authAnimate();

    // Tilt the auth card slightly with the mouse
    const card = document.getElementById("auth-card");
    authScreen.addEventListener("mousemove", (e) => {
      const rect = card.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width  - .5;
      const y = (e.clientY - rect.top)  / rect.height - .5;
      card.style.transform = `rotateY(${x*10}deg) rotateX(${ -y*8 }deg) translateZ(0)`;
    });
    authScreen.addEventListener("mouseleave", () => card.style.transform = "rotateY(0) rotateX(0)");

    // Resize handlers (both scenes)
    addEventListener("resize", () => {
      // chat/auth canvases share full screen
      aCam.aspect = innerWidth/innerHeight;
      aCam.updateProjectionMatrix();
      aRend.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>

